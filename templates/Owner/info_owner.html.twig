{% extends('Common/base.html.twig') %}
{% block title %}
    Info Owner
{% endblock %}
    {%  block header %}
        {% include 'Owner/owner_header.html.twig' %}
    {% endblock %}
{% block body %}


    <div class="card">
        <div class="card-body">

            <h2>General INFO</h2>

            {% verbatim %}
                <script id="owner_template" type="text/x-handlebars-template">
                    <p>Hello, {{ownerName}}</p>
                </script>
            {% endverbatim %}
            <div id="owner_info"></div>

        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>List of Things</h2>


            <table id="list_of_things" class="table table-striped table-sm table-hover">
                <thead class="thead-dark">
                <th>Name</th>
                <th>Brand</th>
                <th>Action</th>
                </thead>
                <tbody>
            {% verbatim %}
                <script id="things_template" type="text/x-handlebars-template">
                    {{#each things}}
                    <!--<tr>-->

                        <!--<td class="alert alert-dark" role="alert"  ><span id="thing_id_{{this.id}}">El id{{this.id}}</span></td>-->
                    <!--</tr>-->
                    {{/each}}
                </script>
            {% endverbatim %}
                </tbody>
            </table>

            <div id="things_info"></div>
            <div id="things"></div>

        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Add new Thing</h2>

            <form action="{{ path('thing_create') }}" method="post">
                <div class="form-group row">
                    <label for="root" class="col-sm-2 col-form-label col-form-label-sm">Id</label>
                    <div class="col-sm-10">
                        <input type="text" name="root" class="form-control" id="root" aria-describedby="emailHelp"
                               placeholder="url">
                    </div>
                    {#            <small  class="form-text text-muted">(url)</small>#}
                </div>
                <div class="form-group row">
                    <label for="user" class="col-sm-2 col-form-label col-form-label-sm">User</label>
                    <div class="col-sm-10">
                        <input type="text" name="user" class="form-control" id="user" aria-describedby="emailHelp"
                               placeholder="user in thing">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="password" class="col-sm-2 col-form-label col-form-label-sm">Password</label>
                    <div class="col-sm-10">
                        <input type="password" name="password" class="form-control" id="password"
                               aria-describedby="emailHelp"
                               placeholder="password in thing">
                    </div>
                </div>
                <input type="submit" value="Add Thing" class="btn btn-primary">
            </form>
        </div>
    </div>


    <script>

        {#var urlForThingConnectedTemplate = {{ url('url_provider_for_thing_info_connected_url_template_provider') }};#}

        $(document).ready(
            function () {
                $.ajax({
                    url: "{{ url('api_owner') }}",
                    success: function (owner) {

                        // fill owner info
                        var ownerTemplate = Handlebars.compile(document.getElementById("owner_template").innerHTML);
                        document.getElementById("owner_info").innerHTML = ownerTemplate({ownerName: owner.name});

                        // fill Things with ConnectedThings
                        owner.things.forEach(function (thing) {
                            fillOneThingOfOwner(thing.id);
                        });

                        // Things
                        var thingTemplate = Handlebars.compile(document.getElementById("things_template").innerHTML);
                        document.getElementById("things_info").innerHTML = thingTemplate({things: owner.things});;
                    },
                    error: function () {
                        window.location.replace("{{ url('login') }}");
                    }
                })
            });

        function fillThingRow(thingConnected, urlForThingInfo, thingId) {

            // console.log(thingConnected);
            // console.log(urlForThingInfo);
            // console.log(thingId);


            var list_of_things_table = $("#list_of_things");

            list_of_things_table.append('<tr>' +
                // '<td>'+thingId+'</td>' +
                '<td>'+thingConnected.data.name+'</td>' +
                '<td>'+thingConnected.data.brand+'</td>' +
                '<td><button onclick="window.location.href = \'' + urlForThingInfo + '\'">Admin</button></td>' +
                '</tr>');


            //
            // var thingElement = $("#thing_id_" + thingId);
            //
            // if (thingConnected.status === true) {
            //     // TODO manage thing front structure with handlebars
            //     thingElement.addClass('thing_ok');
            //     // add name and brand
            //     thingElement.append(' | ' + thingConnected.data.name + ' | ' + thingConnected.data.brand);
            //     // add View/Admin thing
            //     thingElement.append('<button onclick="window.location.href = \'' + urlForThingInfo +
            //         '\'">Admin</button>');
            //
            // }
            // else {
            //     thingElement.addClass('thing_error');
            //     thingElement.append(' | ' + thingConnected.message);
            //
            // }
        }


        function fillOneThingOfOwner(thingId) {

            // (spaghetti code alert) TODO use promises
            $.get({
                url: "{{ url('url_provider_for_thing_info')}}",
                data: {'thingId':thingId},
                success: function (urlThingInfoProvidedResponse) {

                    $.get({
                        url: "{{ url('url_provider_for_api_thing_info') }}",
                        data: {'thingId': thingId},
                        success: function (urlApiThingInfoProvidedResponse) {

                            $.get({
                                url: urlApiThingInfoProvidedResponse,
                                success: function (thingConnectedInfo) {
                                    fillThingRow(thingConnectedInfo, urlThingInfoProvidedResponse, thingId);
                                },
                                error: function (error) {
                                    var thingConnectedInfoWithError = {'status': false, 'message': error
                                            .responseText};
                                    fillThingRow(thingConnectedInfoWithError, '', thingId);
                                }
                            })
                        }
                    })
                }
            });
        }
    </script>
{% endblock %}